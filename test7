#!/bin/bash

input_file="input.csv"    # Replace with your input CSV
output_file="output.csv"  # Output CSV with added 'id' column

# Write the header to the output CSV
echo "project_link,central_id" > "$output_file"

# Loop through the CSV file, skipping the header
tail -n +2 "$input_file" | while IFS=, read -r project_link; do
    # Extract the path from the project link (e.g., org/repo/path)
    repo_path=$(echo "$project_link" | awk -F'/repos/' '{print $2}')

    # Call the GitHub API and decode the YAML content to get the central id
    central_id=$(gh api "repos/$repo_path/contents/.amex/buildblocks.yaml" --jq .content | base64 -d | grep 'id:' | cut -d "'" -f2)

    # Append the project link and central_id to the output CSV
    echo "$project_link,$central_id" >> "$output_file"
done

echo "Processing complete! Check $output_file for results."